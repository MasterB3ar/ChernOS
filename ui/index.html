<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ChernOS v1.6.0 – Black Chamber Update</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --ch-accent: #bff9a8;
      --ch-accent-soft: rgba(191,249,168,0.5);
      --ch-bg: #020806;
      --ch-bg-card: rgba(0,0,0,0.6);
      --ch-text-main: #cfeecb;
      --ch-text-soft: #9ca3af;
      --ch-border-soft: rgba(191,249,168,0.18);
    }

    body {
      margin: 0;
      background:
        radial-gradient(circle at 10% 0%, rgba(0,255,140,0.06), transparent 60%),
        radial-gradient(circle at 90% 0%, rgba(0,255,140,0.03), transparent 55%),
        var(--ch-bg);
      color: var(--ch-text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow-y: auto;
      overflow-x: hidden;
    }

    body.theme-amber {
      --ch-accent: #facc6b;
      --ch-accent-soft: rgba(250,204,107,0.55);
      --ch-bg: #1a1208;
      --ch-bg-card: rgba(10,4,0,0.7);
    }

    body.theme-redline {
      --ch-accent: #fb7185;
      --ch-accent-soft: rgba(248,113,113,0.6);
      --ch-bg: #050009;
      --ch-bg-card: rgba(8,0,12,0.75);
    }

    body.theme-2049 {
      --ch-accent: #38bdf8;
      --ch-accent-soft: rgba(56,189,248,0.6);
      --ch-bg: #020617;
      --ch-bg-card: rgba(2,6,23,0.85);
    }

    .wrap {
      min-height: 100vh;
      padding: 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow-y: auto;
      max-height: 100vh;
      padding-bottom: 40px;
    }

    .reactor-glow {
      position: fixed;
      inset: -40px;
      pointer-events: none;
      background:
        radial-gradient(circle at 15% 10%, rgba(0,255,140,0.06), transparent 70%),
        radial-gradient(circle at 85% -10%, rgba(0,255,140,0.06), transparent 65%);
      mix-blend-mode: screen;
      animation: glowPulse 4s ease-in-out infinite alternate;
      opacity: 0.7;
      z-index: 1;
    }

    body.theme-amber .reactor-glow {
      background:
        radial-gradient(circle at 15% 10%, rgba(250,204,107,0.1), transparent 70%),
        radial-gradient(circle at 85% -10%, rgba(250,204,107,0.08), transparent 65%);
    }

    body.theme-redline .reactor-glow {
      background:
        radial-gradient(circle at 10% 0%, rgba(248,113,113,0.12), transparent 70%),
        radial-gradient(circle at 90% -5%, rgba(239,68,68,0.1), transparent 65%);
    }

    body.theme-2049 .reactor-glow {
      background:
        radial-gradient(circle at 15% 10%, rgba(56,189,248,0.12), transparent 72%),
        radial-gradient(circle at 85% 0%, rgba(168,85,247,0.08), transparent 68%);
    }

    @keyframes glowPulse {
      0% { opacity: 0.4; filter: blur(0); }
      100% { opacity: 0.9; filter: blur(1px); }
    }

    .gamma-overlay {
      position: fixed;
      inset: -20px;
      pointer-events: none;
      background-image:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(59,130,246,0.18), transparent 60%),
        repeating-linear-gradient(
          60deg,
          rgba(56,189,248,0.08),
          rgba(56,189,248,0.08) 2px,
          transparent 2px,
          transparent 6px
        );
      mix-blend-mode: screen;
      opacity: 0;
      transform: scale(1.02);
      transition: opacity 0.35s ease-out;
      z-index: 2;
    }

    .gamma-overlay.active {
      opacity: 0.65;
      animation: gammaSpin 9s linear infinite;
    }

    @keyframes gammaSpin {
      0% { transform: scale(1.02) rotate(0deg); }
      100% { transform: scale(1.02) rotate(360deg); }
    }

    /* Black Chamber overlay */
    .black-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 50% 20%, rgba(0,0,0,0.9), transparent 70%),
        repeating-linear-gradient(
          180deg,
          rgba(15,23,42,0.6),
          rgba(15,23,42,0.6) 2px,
          transparent 2px,
          transparent 4px
        );
      mix-blend-mode: multiply;
      opacity: 0;
      transition: opacity 0.4s ease-out;
      z-index: 3;
    }

    .black-overlay.active {
      opacity: 0.7;
      animation: blackScan 7s linear infinite;
    }

    @keyframes blackScan {
      0% { transform: translateY(0); }
      100% { transform: translateY(12px); }
    }

    .card {
      border-radius: 16px;
      border: 1px solid var(--ch-border-soft);
      background: radial-gradient(circle at top, var(--ch-accent-soft), transparent 110%) var(--ch-bg-card);
      padding: 12px 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 24px rgba(0,0,0,0.75);
      position: relative;
      z-index: 4;
    }

    .label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--ch-text-soft);
    }

    .big {
      font-size: 24px;
      font-weight: 600;
      color: var(--ch-accent);
    }

    .pill {
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(191,249,168,0.25);
      border-color: var(--ch-border-soft);
      color: var(--ch-text-soft);
    }

    .btn {
      padding: 4px 9px;
      border-radius: 7px;
      border: 1px solid rgba(191,249,168,0.25);
      border-color: var(--ch-border-soft);
      font-size: 11px;
      color: var(--ch-accent);
      background: transparent;
      cursor: pointer;
      transition: all 0.16s ease-out;
    }
    .btn:hover {
      background: rgba(0,0,0,0.8);
      box-shadow: 0 0 10px var(--ch-accent-soft);
    }

    .btn-small {
      padding: 3px 7px;
      font-size: 10px;
      border-radius: 999px;
    }

    .badge {
      font-size: 9px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(191,249,168,0.32);
      border-color: var(--ch-border-soft);
      color: var(--ch-accent);
      white-space: nowrap;
    }

    .status-board {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .status-cell {
      font-size: 9px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(191,249,168,0.16);
      border-color: rgba(191,249,168,0.12);
      background: rgba(0,0,0,0.7);
      color: var(--ch-text-soft);
      position: relative;
      overflow: hidden;
    }

    .status-cell::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(191,249,168,0.06), transparent);
      mix-blend-mode: screen;
      opacity: 0;
      animation: flicker 3.4s infinite;
    }

    @keyframes flicker {
      0%,82%,100% { opacity: 0; }
      84% { opacity: 0.2; }
      87% { opacity: 0.04; }
      90% { opacity: 0.17; }
      93% { opacity: 0; }
    }

    .core-ring-wrap {
      width: 100px;
      height: 100px;
      position: relative;
    }

    .core-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid rgba(191,249,168,0.25);
      border-color: var(--ch-accent-soft);
      box-shadow: 0 0 14px rgba(0,0,0,0.9);
      animation: ringSpin 9s linear infinite;
    }

    .core-ring.inner {
      inset: 16px;
      border-width: 2px;
      animation-duration: 6s;
      animation-direction: reverse;
      border-color: rgba(255,255,255,0.35);
    }

    .core-dot {
      position: absolute;
      inset: 32px;
      border-radius: 50%;
      background: radial-gradient(circle, var(--ch-accent), transparent);
      box-shadow: 0 0 18px var(--ch-accent-soft);
      transition: box-shadow 0.3s ease-out, transform 0.25s ease-out, background 0.2s;
    }

    @keyframes ringSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    input[type="range"].lever {
      width: 130px;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      outline: none;
    }
    input[type="range"].lever::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--ch-accent);
      box-shadow: 0 0 6px var(--ch-accent-soft);
      cursor: pointer;
      border: 1px solid rgba(0,0,0,0.7);
    }
    input[type="range"].lever::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--ch-accent);
      cursor: pointer;
      border: none;
    }

    #log {
      max-height: 190px;
      overflow-y: auto;
      font-size: 10px;
      line-height: 1.35;
    }

    #log::-webkit-scrollbar {
      width: 6px;
    }
    #log::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.6);
      border-radius: 999px;
    }

    .term-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      margin-top: 6px;
    }

    #term-input {
      width: 100%;
      background: rgba(0,0,0,0.85);
      border-radius: 7px;
      border: 1px solid var(--ch-border-soft);
      padding: 6px 8px;
      font-size: 12px;
      color: var(--ch-text-main);
      outline: none;
    }
    #term-input:focus {
      box-shadow: 0 0 9px var(--ch-accent-soft);
    }

    .graphs {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin-top: 6px;
    }

    canvas {
      width: 100%;
      height: 58px;
      border-radius: 8px;
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(15,23,42,0.9);
    }

    .diag-active {
      box-shadow: 0 0 18px var(--ch-accent-soft);
      border-color: rgba(191,249,168,0.5);
    }

    .overdrive-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .soft {
      color: var(--ch-text-soft);
      font-size: 11px;
    }

    .crit {
      color: #fb7185;
    }

    .warn {
      color: #facc6b;
    }

    .ok {
      color: #4ade80;
    }

    .theme-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .theme-btn {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.75);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.16s;
      color: #ffffff;
    }
    .theme-btn.active {
      border-color: var(--ch-accent-soft);
      box-shadow: 0 0 9px var(--ch-accent-soft);
    }

    .theme-btn[data-theme="2049"] {
      border-color: #38bdf8 !important;
      color: #ffffff !important;
    }

    .mute-indicator {
      font-size: 10px;
      color: var(--ch-text-soft);
    }

    .contain-pill {
      font-size: 9px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.85);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 4px;
    }

    .contain-pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
    }

    .contain-pill.alpha span.dot { background: #22c55e; }
    .contain-pill.beta span.dot  { background: #facc6b; }
    .contain-pill.gamma span.dot { background: #fb7185; }

    .contain-pill.off span.dot {
      background: #4b5563;
    }

    .lockdown-active {
      box-shadow: 0 0 16px rgba(248,113,113,0.7);
      border-color: rgba(248,113,113,0.7) !important;
    }

    .chamber-active {
      box-shadow: 0 0 16px rgba(15,23,42,0.9);
      border-color: rgba(15,23,42,0.9) !important;
      background: rgba(2,6,23,0.95) !important;
    }

    .comms-pill {
      font-size: 9px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 4px;
    }

    .comms-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4b5563;
    }

    .comms-dot.on {
      background: #22c55e;
    }

    .comms-dot.ghost {
      background: #a855f7;
    }
  </style>
</head>
<body class="theme-green">
  <div class="reactor-glow"></div>
  <div id="gamma-overlay" class="gamma-overlay"></div>
  <div id="black-overlay" class="black-overlay"></div>

  <div class="wrap">
    <!-- TOP BAR -->
    <div class="card flex flex-wrap items-start justify-between gap-4">
      <div class="space-y-2">
        <div class="label">ChernOS v1.6.0 – Black Chamber Update</div>
        <div class="text-2xl font-semibold" id="title-main">
          Reactor + Containment + Black Chamber Console
        </div>
        <div class="status-board">
          <div class="status-cell">CORE CHANNELS: SYNCED</div>
          <div class="status-cell">COOLANT GRID: STABLE</div>
          <div class="status-cell">CONTAINMENT BUS: ARMED</div>
          <div class="status-cell">BLACK CHAMBER: STANDBY</div>
          <div class="status-cell">DIAGNOSTICS ENGINE: READY</div>
          <div class="status-cell">OVERDRIVE/CONTAINMENT: ONLINE</div>
        </div>
      </div>

      <div class="flex flex-col gap-3 items-end">
        <div class="flex flex-wrap gap-2 items-center">
          <span class="badge" id="badge-sim">SIM-CORE ONLINE</span>
          <span class="badge" id="badge-overdrive">OVERDRIVE: OFF</span>
          <span class="badge" id="badge-diag">DIAGNOSTICS: OFF</span>
          <span class="badge" id="badge-contain">CONTAINMENT: STABLE</span>
          <span class="badge" id="badge-lockdown">LOCKDOWN: OFF</span>
          <span class="badge" id="badge-satlink">SATLINK: OFF</span>
          <span class="badge" id="badge-black">BLACK CHAMBER: IDLE</span>
        </div>

        <div class="flex gap-6 items-center">
          <div class="core-ring-wrap">
            <div class="core-ring"></div>
            <div class="core-ring inner"></div>
            <div class="core-dot" id="core-dot"></div>
          </div>
          <div class="flex flex-col gap-2 items-end">
            <div class="flex gap-2">
              <button class="btn" id="btn-diag-toggle">Diagnostics</button>
              <button class="btn" id="btn-overdrive-toggle">Overdrive</button>
            </div>
            <div class="flex gap-2">
              <button class="btn" id="btn-audio-toggle">Toggle Audio</button>
              <span class="mute-indicator" id="audio-state">Audio: ON</span>
            </div>

            <div class="flex gap-2 mt-1">
              <button class="theme-btn active" data-theme="green">
                <span class="theme-dot" style="background:#22c55e;"></span>Green
              </button>
              <button class="theme-btn" data-theme="amber">
                <span class="theme-dot" style="background:#facc6b;"></span>Amber
              </button>
              <button class="theme-btn" data-theme="redline">
                <span class="theme-dot" style="background:#fb7185;"></span>Redline
              </button>
            </div>

            <div class="mt-2 text-right text-xs text-slate-300">
              <div id="op-name-line">Operator: ANON / Lvl 1</div>
              <div id="op-status-line">Clearance: TECHNICIAN</div>
              <div id="remote-status-line" class="text-[10px] text-slate-400 mt-1">
                Remote link: LOCAL ONLY
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TELEMETRY STRIP -->
    <div class="grid grid-cols-4 gap-2">
      <div class="card">
        <div class="label">CORE TEMP</div>
        <div class="big" id="read-temp">312°C</div>
        <div class="soft mt-1" id="status-temp">Nominal</div>
      </div>

      <div class="card">
        <div class="label">PRESSURE COUPLING</div>
        <div class="big" id="read-pressure">1.30 MPa</div>
        <div class="soft mt-1" id="status-pressure">Stable</div>
      </div>

      <div class="card">
        <div class="label">RADIATION FLUX</div>
        <div class="big" id="read-rad">0.14 mSv/h</div>
        <div class="soft mt-1" id="status-rad">Shielded</div>
      </div>

      <div class="card">
        <div class="label">SAFEGUARDS & DRIVE</div>
        <div class="flex justify-between items-center">
          <div>
            <div class="text-lg font-semibold" id="read-sg">3 / 3</div>
            <div class="overdrive-label mt-1" id="overdrive-state-label">OVERDRIVE: DISARMED</div>
          </div>
          <div class="flex flex-col gap-1 ml-2">
            <div class="text-[10px] text-slate-400">Core Drive</div>
            <input id="lever-core" type="range" min="40" max="125" value="80" class="lever">
            <div class="text-[10px] text-slate-400 mt-1">Coolant Bias</div>
            <input id="lever-coolant" type="range" min="80" max="145" value="100" class="lever">
          </div>
        </div>
        <div class="flex flex-wrap gap-2 mt-2">
          <span class="pill">SCRAM RODS</span>
          <span class="pill">COOLANT SURGE</span>
          <span class="pill">CONTAINMENT SEAL</span>
        </div>
      </div>
    </div>

    <!-- CONTAINMENT PANEL -->
    <div class="card mt-1">
      <div class="label">CONTAINMENT PROTOCOLS</div>
      <div class="mt-2 flex flex-wrap gap-2 items-center">
        <div class="contain-pill alpha" id="pill-alpha">
          <span class="dot"></span>
          <span>CFA (Thermal Buffer)</span>
        </div>
        <div class="contain-pill beta" id="pill-beta">
          <span class="dot"></span>
          <span>CFB (Pressure Latch)</span>
        </div>
        <div class="contain-pill gamma" id="pill-gamma">
          <span class="dot"></span>
          <span>CFG (Gamma Field)</span>
        </div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2">
        <button class="btn btn-small" id="btn-cfa-toggle">Toggle Alpha</button>
        <button class="btn btn-small" id="btn-cfb-reset">Reset Beta Latch</button>
        <button class="btn btn-small" id="btn-cfg-toggle">Toggle Gamma Field</button>
        <button class="btn btn-small" id="btn-contain-pulse">Pulse Sweep</button>
        <button class="btn btn-small" id="btn-lockdown-toggle">Lockdown</button>
      </div>
      <div class="mt-2 text-[10px] text-slate-400">
        Terminal shortcuts:
        <span class="pill text-[10px]">containment status</span>
        <span class="pill text-[10px]">lockdown on/off</span>
        <span class="pill text-[10px]">operator set &lt;name&gt;</span>
        <span class="pill text-[10px]">operator level &lt;n&gt;</span>
      </div>
    </div>

    <!-- COMMS / BLACK CHAMBER PANEL -->
    <div class="card mt-1" id="comms-card">
      <div class="label">COMMS / BLACK CHAMBER</div>
      <div class="mt-2 flex flex-wrap gap-2 items-center">
        <div class="comms-pill" id="pill-satlink">
          <span class="comms-dot" id="dot-satlink"></span>
          <span>Satellite Link</span>
        </div>
        <div class="comms-pill" id="pill-ghost">
          <span class="comms-dot" id="dot-ghost"></span>
          <span>Ghost Mirror</span>
        </div>
        <div class="comms-pill" id="pill-black">
          <span class="comms-dot" id="dot-black"></span>
          <span>Black Chamber</span>
        </div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2">
        <button class="btn btn-small" id="btn-satlink-toggle">Toggle SatLink</button>
        <button class="btn btn-small" id="btn-ghost-toggle">Toggle Ghost Mirror</button>
        <button class="btn btn-small" id="btn-black-toggle">Toggle Black Chamber</button>
        <button class="btn btn-small" id="btn-macro-rec">Macro Rec</button>
        <button class="btn btn-small" id="btn-macro-play">Macro Play</button>
      </div>
      <div class="mt-2 text-[10px] text-slate-400">
        Terminal shortcuts:
        <span class="pill text-[10px]">satlink on/off</span>
        <span class="pill text-[10px]">ghost on/off</span>
        <span class="pill text-[10px]">black on/off</span>
        <span class="pill text-[10px]">macro rec / stop / play</span>
      </div>
    </div>

    <!-- CONTROLS + TERMINAL + LOG -->
    <div class="grid grid-cols-[minmax(0,1.1fr)_minmax(0,1.2fr)] gap-3">
      <div class="card">
        <div class="label">OPERATOR CONTROL SURFACE</div>
        <div class="flex flex-wrap gap-2 mt-2">
          <button class="btn" id="btn-scram">SCRAM</button>
          <button class="btn" id="btn-relief">Relief</button>
          <button class="btn" id="btn-stress">Stress Pulse</button>
          <button class="btn" id="btn-chaos">Force Failure</button>
          <button class="btn" id="btn-reset">Reset</button>
        </div>
        <div class="flex flex-wrap gap-2 mt-3">
          <span class="pill text-[10px]">
            Terminal: help · status · containment status · satlink on/off · ghost on/off ·
            black on/off · macro rec/stop/play
          </span>
        </div>

        <div class="term-grid">
          <input id="term-input" autocomplete="off"
            placeholder="terminal (help, status, power &lt;n&gt;, coolant &lt;n&gt;, overdrive on/off, diag on/off, containment status, lockdown on/off, satlink on/off, ghost on/off, black on/off, macro rec/stop/play, operator set &lt;name&gt;, operator level &lt;0–3&gt;)">
          <button class="btn" id="term-run">Run</button>
        </div>
      </div>

      <div class="card">
        <div class="label">EVENT LOG (SIMULATION)</div>
        <div id="log" class="mt-2"></div>
      </div>
    </div>

    <!-- DIAGNOSTICS -->
    <div class="card mt-1" id="diag-card" style="display:none">
      <div class="label">DIAGNOSTICS MODE — LIVE TELEMETRY GRAPHS</div>
      <div class="graphs">
        <div>
          <div class="text-[10px] text-slate-400 mb-1">Core Temp</div>
          <canvas id="g-core" width="260" height="60"></canvas>
        </div>
        <div>
          <div class="text-[10px] text-slate-400 mb-1">Pressure</div>
          <canvas id="g-press" width="260" height="60"></canvas>
        </div>
        <div>
          <div class="text-[10px] text-slate-400 mb-1">Radiation</div>
          <canvas id="g-rad" width="260" height="60"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    //   ChernOS v1.6.0 — Black Chamber Update (purely fictional)
    // ============================================================

    // ----- DOM Refs -----
    const elTemp      = document.getElementById("read-temp");
    const elTempStat  = document.getElementById("status-temp");
    const elP         = document.getElementById("read-pressure");
    const elPStat     = document.getElementById("status-pressure");
    const elR         = document.getElementById("read-rad");
    const elRStat     = document.getElementById("status-rad");
    const elSG        = document.getElementById("read-sg");
    const elOverLbl   = document.getElementById("overdrive-state-label");
    const elCoreDot   = document.getElementById("core-dot");
    const elBadgeOver = document.getElementById("badge-overdrive");
    const elBadgeDiag = document.getElementById("badge-diag");
    const elBadgeSim  = document.getElementById("badge-sim");
    const elBadgeContain = document.getElementById("badge-contain");
    const elBadgeLockdown = document.getElementById("badge-lockdown");
    const elBadgeSat  = document.getElementById("badge-satlink");
    const elBadgeBlack= document.getElementById("badge-black");
    const elAudioState= document.getElementById("audio-state");
    const elDiagCard  = document.getElementById("diag-card");
    const elLog       = document.getElementById("log");
    const elTitle     = document.getElementById("title-main");
    const elGammaOverlay = document.getElementById("gamma-overlay");
    const elBlackOverlay = document.getElementById("black-overlay");
    const elOpNameLine   = document.getElementById("op-name-line");
    const elOpStatusLine = document.getElementById("op-status-line");
    const elRemoteStatus = document.getElementById("remote-status-line");

    const pillAlpha  = document.getElementById("pill-alpha");
    const pillBeta   = document.getElementById("pill-beta");
    const pillGamma  = document.getElementById("pill-gamma");

    const pillSat    = document.getElementById("pill-satlink");
    const pillGhost  = document.getElementById("pill-ghost");
    const pillBlack  = document.getElementById("pill-black");
    const dotSat     = document.getElementById("dot-satlink");
    const dotGhost   = document.getElementById("dot-ghost");
    const dotBlack   = document.getElementById("dot-black");

    const leverCore   = document.getElementById("lever-core");
    const leverCool   = document.getElementById("lever-coolant");

    const btnScram    = document.getElementById("btn-scram");
    const btnRelief   = document.getElementById("btn-relief");
    const btnStress   = document.getElementById("btn-stress");
    const btnChaos    = document.getElementById("btn-chaos");
    const btnReset    = document.getElementById("btn-reset");
    const btnDiag     = document.getElementById("btn-diag-toggle");
    const btnOver     = document.getElementById("btn-overdrive-toggle");
    const btnAudio    = document.getElementById("btn-audio-toggle");
    const btnCfa      = document.getElementById("btn-cfa-toggle");
    const btnCfb      = document.getElementById("btn-cfb-reset");
    const btnCfg      = document.getElementById("btn-cfg-toggle");
    const btnPulse    = document.getElementById("btn-contain-pulse");
    const btnLockdown = document.getElementById("btn-lockdown-toggle");

    const btnSatlink  = document.getElementById("btn-satlink-toggle");
    const btnGhost    = document.getElementById("btn-ghost-toggle");
    const btnBlack    = document.getElementById("btn-black-toggle");
    const btnMacroRec = document.getElementById("btn-macro-rec");
    const btnMacroPlay= document.getElementById("btn-macro-play");

    const termInput   = document.getElementById("term-input");
    const termRun     = document.getElementById("term-run");

    const themeButtons = Array.from(document.querySelectorAll(".theme-btn"));

    // Graph canvases
    const gcCore  = document.getElementById("g-core");
    const gcPress = document.getElementById("g-press");
    const gcRad   = document.getElementById("g-rad");

    // ----- Simulation state -----
    const histLen = 90;
    let histTemp  = [];
    let histPress = [];
    let histRad   = [];

    const state = {
      temp: 312,
      pressure: 1.3,
      rad: 0.14,
      safeguards: 3,
      overdrive: false,
      meltdownStage: 0, // 0..5
      diagnostics: false,
      audioOn: true,
      theme: "green",
      persistEnabled: false,
      ticks: 0,
      microJitter: 0,
      lockdown: false,
      implosionPlayed: false,
      containment: {
        alpha: false,
        betaLatched: false,
        gamma: false
      },
      operatorName: "ANON",
      operatorLevel: 1,
      satLink: false,
      ghostLink: false,
      blackChamber: false,
      macroRecording: false,
      macroBuffer: []
    };

    // URL params
    const params = new URLSearchParams(window.location.search);
    if (params.get("persist") === "1") {
      state.persistEnabled = true;
    }
    if (params.get("op")) {
      state.operatorName = decodeURIComponent(params.get("op"));
    }
    if (params.get("lvl")) {
      const lvl = parseInt(params.get("lvl"), 10);
      if (!isNaN(lvl)) {
        state.operatorLevel = Math.min(3, Math.max(0, lvl));
      }
    }

    function levelLabel(lvl) {
      if (lvl === 0) return "GUEST";
      if (lvl === 1) return "TECHNICIAN";
      if (lvl === 2) return "ENGINEER";
      if (lvl === 3) return "DIRECTOR";
      return "UNKNOWN";
    }

    function updateOperatorLines() {
      elOpNameLine.textContent = `Operator: ${state.operatorName || "ANON"} / Lvl ${state.operatorLevel}`;
      elOpStatusLine.textContent = `Clearance: ${levelLabel(state.operatorLevel)}`;
    }
    updateOperatorLines();

    // ----- Logging & (optional) persistence -----
    function maybePersist(line) {
      if (!state.persistEnabled) return;
      try {
        if (navigator.sendBeacon) {
          const blob = new Blob([line], { type: "text/plain" });
          navigator.sendBeacon("/persist/chernos-logs/log.txt", blob);
        }
      } catch (e) {}
    }

    function log(msg) {
      const t = new Date().toISOString().slice(11, 19);
      const line = `[${t}] ${msg}`;
      const div = document.createElement("div");
      div.textContent = line;
      elLog.prepend(div);
      maybePersist(line + "\n");
      if (state.macroRecording && !msg.startsWith("> macro")) {
        // logs are not recorded, only operator commands via runCommand
      }
    }

    log("SIM: ChernOS v1.6.0 Black Chamber console ready.");

    // ----- Audio Engine v3 -----
    let audioCtx = null;
    let humNode = null;
    let coolantNode = null;
    let crackNode = null;
    let sirenNode = null;
    let containNode = null;
    let gammaNode = null;

    function ensureAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        audioCtx = null;
      }
    }

    function startHum() {
      if (!state.audioOn || !audioCtx || humNode) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = 50;
      g.gain.value = 0.03;
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start();
      humNode = { osc, g };
    }

    function startCoolant() {
      if (!state.audioOn || !audioCtx || coolantNode) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = "triangle";
      osc.frequency.value = 19;
      g.gain.value = 0.02;
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start();
      coolantNode = { osc, g };
    }

    function startCrackle() {
      if (!state.audioOn || !audioCtx || crackNode) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = "square";
      osc.frequency.value = 1200;
      g.gain.value = 0.0;
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start();
      const iv = setInterval(() => {
        if (!state.audioOn || state.meltdownStage === 0) {
          g.gain.value = 0.0;
          return;
        }
        g.gain.value = (Math.random() < 0.35 ? 0.03 : 0.0);
      }, 90);
      crackNode = { osc, g, iv };
    }

    function startSiren() {
      if (!state.audioOn || !audioCtx || sirenNode) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = "sawtooth";
      g.gain.value = 0.0;
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start();

      let up = true;
      const iv = setInterval(() => {
        if (!state.audioOn || state.meltdownStage < 2) {
          g.gain.value = 0.0;
          return;
        }
        up = !up;
        osc.frequency.value = up ? 720 : 540;
        g.gain.value = up ? 0.08 : 0.02;
      }, 280);

      sirenNode = { osc, g, iv };
    }

    function startContainHum() {
      if (!state.audioOn || !audioCtx || containNode) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = 35;
      g.gain.value = 0.0;
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start();
      containNode = { osc, g };
    }

    function updateContainHumGain() {
      if (!containNode) return;
      const activeCount =
        (state.containment.alpha ? 1 : 0) +
        (state.containment.betaLatched ? 1 : 0) +
        (state.containment.gamma ? 1 : 0) +
        (state.blackChamber ? 1 : 0);
      containNode.g.gain.value = state.audioOn ? Math.min(0.055, activeCount * 0.015) : 0;
    }

    function startGammaCharge() {
      if (!state.audioOn || !audioCtx || gammaNode) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = "triangle";
      osc.frequency.value = 260;
      g.gain.value = 0.0;
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start();

      let up = true;
      const iv = setInterval(() => {
        if (!state.audioOn || (!state.containment.gamma && !state.blackChamber)) {
          g.gain.value = 0.0;
          return;
        }
        up = !up;
        osc.frequency.value = up ? 260 : 320;
        g.gain.value = up ? 0.03 : 0.01;
      }, 220);

      gammaNode = { osc, g, iv };
    }

    function playImplosion() {
      if (!state.audioOn || !audioCtx) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = 90;
      g.gain.value = 0.12;
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start();
      setTimeout(() => g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2), 40);
      setTimeout(() => { try { osc.stop(); } catch (_) {} }, 400);
    }

    function stopNode(nodeObj, hasInterval) {
      if (!nodeObj) return;
      if (hasInterval && nodeObj.iv) clearInterval(nodeObj.iv);
      try { nodeObj.osc.stop(); } catch (_) {}
    }

    function stopAllAudio() {
      stopNode(humNode, false); humNode = null;
      stopNode(coolantNode, false); coolantNode = null;
      stopNode(crackNode, true); crackNode = null;
      stopNode(sirenNode, true); sirenNode = null;
      stopNode(containNode, false); containNode = null;
      stopNode(gammaNode, true); gammaNode = null;
    }

    function applyAudioState() {
      if (!state.audioOn) {
        stopAllAudio();
        elAudioState.textContent = "Audio: OFF";
        return;
      }
      ensureAudio();
      elAudioState.textContent = "Audio: ON";
      startHum();
      startCoolant();
      startCrackle();
      startSiren();
      startContainHum();
      startGammaCharge();
      updateContainHumGain();
    }

    btnAudio.addEventListener("click", () => {
      state.audioOn = !state.audioOn;
      applyAudioState();
    });

    window.addEventListener("load", () => {
      setTimeout(() => {
        ensureAudio();
        applyAudioState();
      }, 400);
    });

    // ----- Graph helpers -----
    function pushHist(buf, v) {
      buf.push(v);
      if (buf.length > histLen) buf.shift();
    }

    function drawGraph(canvas, data, color) {
      if (!canvas || !canvas.getContext) return;
      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      if (data.length < 2) return;

      let min = data[0], max = data[0];
      for (let i=1; i<data.length; i++) {
        if (data[i] < min) min = data[i];
        if (data[i] > max) max = data[i];
      }
      let span = max - min;
      if (span === 0) span = 1;

      ctx.beginPath();
      ctx.strokeStyle = color;
      ctx.lineWidth = 1;

      for (let i=0; i<data.length; i++) {
        const x = (i / (data.length - 1)) * (w - 4) + 2;
        const y = h - 4 - ((data[i] - min) / span) * (h - 8);
        if (i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    function renderGraphs() {
      if (!state.diagnostics) return;
      drawGraph(gcCore,  histTemp,  "#bbf7d0");
      drawGraph(gcPress, histPress, "#86efac");
      drawGraph(gcRad,   histRad,   "#4ade80");
    }

    // ----- Rendering -----
    function renderTelemetry() {
      elTemp.textContent = Math.round(state.temp) + "°C";
      elP.textContent    = state.pressure.toFixed(2) + " MPa";
      elR.textContent    = state.rad.toFixed(2) + " mSv/h";
      elSG.textContent   = state.safeguards + " / 3";

      const t = state.temp;
      const p = state.pressure;
      const r = state.rad;

      if (t > 1450) {
        elTempStat.textContent = "Stage 3–4 runaway (sim)";
        elTempStat.className = "soft crit";
      } else if (t > 1150) {
        elTempStat.textContent = "Critical overheating (sim)";
        elTempStat.className = "soft crit";
      } else if (t > 730) {
        elTempStat.textContent = "Approaching redline (sim)";
        elTempStat.className = "soft warn";
      } else {
        elTempStat.textContent = "Nominal";
        elTempStat.className = "soft ok";
      }

      if (p > 6.2) {
        elPStat.textContent = "Containment strain (sim)";
        elPStat.className = "soft crit";
      } else if (p > 3.3) {
        elPStat.textContent = "Elevated coupling (sim)";
        elPStat.className = "soft warn";
      } else {
        elPStat.textContent = "Stable";
        elPStat.className = "soft ok";
      }

      if (r > 4.0) {
        elRStat.textContent = "Severe release (sim)";
        elRStat.className = "soft crit";
      } else if (r > 0.8) {
        elRStat.textContent = "Leak indicated (sim)";
        elRStat.className = "soft warn";
      } else {
        elRStat.textContent = "Shielding effective";
        elRStat.className = "soft ok";
      }

      if (!state.overdrive) {
        elOverLbl.textContent = "OVERDRIVE: DISARMED";
      } else if (state.meltdownStage === 0) {
        elOverLbl.textContent = "OVERDRIVE: ACTIVE (sim boost)";
      } else {
        elOverLbl.textContent = "OVERDRIVE: LOCKED (meltdown sim)";
      }

      const base = state.overdrive ? 1.1 : 0.75;
      const heatFactor = Math.min(1, Math.max(0, (t - 280) / 900));
      const meltdownBoost = state.meltdownStage > 0 ? 0.3 * state.meltdownStage : 0;
      const intensity = base + heatFactor * 1.2 + meltdownBoost;
      const glow = 14 + 26 * intensity;
      const colorShift = state.blackChamber ? "#0f172a" :
                         state.meltdownStage >= 4 ? "#fb7185" :
                         state.meltdownStage >= 2 ? "#f97316" :
                         "var(--ch-accent)";
      elCoreDot.style.boxShadow = `0 0 ${glow}px rgba(191,249,168,${0.45 + intensity * 0.25})`;
      elCoreDot.style.transform  = `scale(${0.9 + intensity * 0.22})`;
      elCoreDot.style.background = `radial-gradient(circle, ${colorShift}, transparent)`;
    }

    function updateContainPills() {
      function setPill(el, active, crit) {
        el.classList.remove("off");
        el.style.borderColor = active ? "rgba(191,249,168,0.6)" : "rgba(148,163,184,0.4)";
        const dot = el.querySelector("span.dot");
        if (!dot) return;
        if (!active) {
          dot.style.background = "#4b5563";
        } else if (crit) {
          dot.style.background = "#fb7185";
        } else {
          dot.style.background = "#22c55e";
        }
      }
      setPill(pillAlpha, state.containment.alpha, false);
      setPill(pillBeta, state.containment.betaLatched, state.containment.betaLatched && state.meltdownStage >= 2);
      setPill(pillGamma, state.containment.gamma, state.meltdownStage >= 3);
    }

    function updateCommsPills() {
      dotSat.classList.toggle("on", state.satLink);
      dotGhost.classList.toggle("on", state.ghostLink);
      dotGhost.classList.toggle("ghost", state.ghostLink);
      dotBlack.classList.toggle("on", state.blackChamber);
      pillBlack.classList.toggle("chamber-active", state.blackChamber);

      if (!state.satLink && !state.ghostLink) {
        elRemoteStatus.textContent = "Remote link: LOCAL ONLY";
      } else if (state.satLink && !state.ghostLink) {
        elRemoteStatus.textContent = "Remote link: SATELLITE UPLINK (sim)";
      } else if (!state.satLink && state.ghostLink) {
        elRemoteStatus.textContent = "Remote link: GHOST MIRROR (sim)";
      } else {
        elRemoteStatus.textContent = "Remote link: SAT+GHOST ROUTING (sim)";
      }
    }

    function renderBadges() {
      elBadgeOver.textContent = "OVERDRIVE: " + (state.overdrive ? "ON" : "OFF");
      elBadgeOver.style.color = state.overdrive ? "#fb7185" : "#9ca3af";

      elBadgeDiag.textContent = "DIAGNOSTICS: " + (state.diagnostics ? "ON" : "OFF");
      elBadgeDiag.style.color = state.diagnostics ? "#bbf7d0" : "#9ca3af";

      elBadgeSim.textContent = "SIM-CORE ONLINE";

      const anyContain = state.containment.alpha || state.containment.betaLatched || state.containment.gamma;
      elBadgeContain.textContent = "CONTAINMENT: " +
        (state.meltdownStage >= 4 && !state.containment.gamma ? "BREACH" :
         state.meltdownStage >= 2 ? "ENGAGED" :
         anyContain ? "ARMED" : "STABLE");
      elBadgeContain.style.color =
        (state.meltdownStage >= 4 && !state.containment.gamma) ? "#fb7185" :
        (state.meltdownStage >= 2 || anyContain) ? "#facc6b" :
        "#bbf7d0";

      elBadgeLockdown.textContent = "LOCKDOWN: " + (state.lockdown ? "ON" : "OFF");
      elBadgeLockdown.style.color = state.lockdown ? "#fb7185" : "#9ca3af";

      elBadgeSat.textContent = "SATLINK: " + (state.satLink ? "ON" : "OFF");
      elBadgeSat.style.color = state.satLink ? "#bbf7d0" : "#9ca3af";

      elBadgeBlack.textContent = "BLACK CHAMBER: " + (state.blackChamber ? "ACTIVE" : "IDLE");
      elBadgeBlack.style.color = state.blackChamber ? "#facc6b" : "#9ca3af";
    }

    function renderGammaOverlay() {
      if (state.containment.gamma) {
        elGammaOverlay.classList.add("active");
      } else {
        elGammaOverlay.classList.remove("active");
      }
    }

    function renderBlackOverlay() {
      if (state.blackChamber) {
        elBlackOverlay.classList.add("active");
      } else {
        elBlackOverlay.classList.remove("active");
      }
    }

    function renderAll() {
      renderTelemetry();
      renderBadges();
      renderGammaOverlay();
      renderBlackOverlay();
      updateContainPills();
      updateCommsPills();
      renderGraphs();
    }

    // ----- Simulation Engine (meltdown v2.0) -----
    function stepSim() {
      state.ticks++;

      const drive  = parseInt(leverCore.value, 10)   / 100;
      const cool   = parseInt(leverCool.value, 10)   / 100;
      const jitter = (Math.random() - 0.5);

      state.microJitter = 0.3 * jitter;

      let dT = jitter * 2.2 + (drive - 0.85) * 5.2 - (cool - 1.0) * 3.4;
      let dP = jitter * 0.07 + (state.temp - 320) / 2600;
      let dR = jitter * 0.02 + Math.max(0, (state.temp - 420)) / 6400;

      if (state.overdrive && state.meltdownStage === 0 && !state.lockdown) {
        dT *= 1.8;
        dP *= 1.5;
        dR *= 1.7;
      }

      if (state.containment.alpha) {
        dT *= 0.8;
      }

      if (state.containment.betaLatched) {
        dP *= 0.5;
      }

      if (state.blackChamber) {
        dR *= 0.9;
        dP *= 0.95;
      }

      if (state.meltdownStage === 0) {
        if (state.temp > 1220 && state.safeguards > 0) {
          state.safeguards -= 1;
          state.temp -= 260;
          state.pressure -= 0.9;
          state.rad -= 0.25;
          log("AUTO-SAFEGUARD (sim): staged insertion + coolant surge.");
        }

        if (state.temp > 1300 && state.pressure > 5.0 && state.safeguards === 0) {
          state.meltdownStage = 1;
          log("MELTDOWN STAGE 1 (sim): Thermal spike detected.");
        }
      } else if (state.meltdownStage === 1) {
        dT += 12.0;
        dP += 0.09;
        dR += 0.14;
        if (state.temp > 1400) {
          state.meltdownStage = 2;
          state.containment.betaLatched = true;
          log("MELTDOWN STAGE 2 (sim): Pressure surge, Beta latch engaged.");
        }
      } else if (state.meltdownStage === 2) {
        dT += 20;
        dP += 0.05;
        dR += 0.25;
        if (state.rad > 1.7) {
          state.meltdownStage = 3;
          log("MELTDOWN STAGE 3 (sim): Radiation breach indicated.");
        }
      } else if (state.meltdownStage === 3) {
        dT += 26;
        dP -= 0.05;
        dR += 0.4;
        if (!state.containment.gamma && state.rad > 3.5) {
          state.meltdownStage = 4;
          log("MELTDOWN STAGE 4 (sim): Containment failure visualized.");
        } else if (state.containment.gamma && state.rad > 3.5) {
          state.meltdownStage = 4;
          log("MELTDOWN STAGE 4 (sim): Gamma field holding collapse (visual only).");
        }
      } else if (state.meltdownStage === 4) {
        dT += 14;
        dP = Math.max(0.6, state.pressure - 0.2);
        dR += 0.18;

        if (!state.containment.gamma && state.rad > 4.2 && !state.lockdown) {
          state.meltdownStage = 5;
          log("MELTDOWN STAGE 5 (sim): Core implosion depicted.");
          if (!state.implosionPlayed) {
            state.implosionPlayed = true;
            playImplosion();
          }
        } else if (state.containment.gamma) {
          dT -= 10;
          dR -= 0.2;
        }
      } else if (state.meltdownStage === 5) {
        dT -= 18;
        dP = Math.max(0.7, state.pressure - 0.25);
        dR -= 0.26;
      }

      state.temp     += dT;
      state.pressure += dP;
      state.rad      += dR;

      if (state.temp < 260) state.temp = 260;
      if (state.pressure < 0.9) state.pressure = 0.9;
      if (state.rad < 0.05) state.rad = 0.05;

      pushHist(histTemp,  state.temp);
      pushHist(histPress, state.pressure);
      pushHist(histRad,   state.rad);

      renderAll();
    }

    setInterval(stepSim, 850);

    // ----- Operator actions -----
    function doScram() {
      log("OP: SCRAM (sim)");
      state.temp -= 360;
      state.pressure -= 1.2;
      state.rad -= 0.35;
      if (state.temp < 260) state.temp = 260;
      if (state.pressure < 0.9) state.pressure = 0.9;
      if (state.rad < 0.05) state.rad = 0.05;
      if (state.meltdownStage > 0) {
        log("SCRAM (sim): meltdown chain remains in visual mode only.");
      }
      renderAll();
    }

    function doRelief() {
      log("OP: Relief valves (sim)");
      state.pressure -= 0.7;
      if (state.pressure < 0.9) state.pressure = 0.9;
      renderAll();
    }

    function doStress() {
      log("OP: Stress pulse (sim)");
      state.temp += 260;
      state.pressure += 1.4;
      state.rad += 0.45;
      renderAll();
    }

    function doChaos() {
      log("OP: Forced safeguard bypass (sim)");
      state.safeguards = 0;
      state.temp = 1250;
      state.pressure = 5.3;
      state.rad = 1.6;
      renderAll();
    }

    function resetSim() {
      state.temp = 312;
      state.pressure = 1.3;
      state.rad = 0.14;
      state.safeguards = 3;
      state.meltdownStage = 0;
      state.implosionPlayed = false;
      histTemp = [];
      histPress = [];
      histRad = [];
      log("Simulation reset to nominal baseline.");
      renderAll();
    }

    btnScram.addEventListener("click", doScram);
    btnRelief.addEventListener("click", doRelief);
    btnStress.addEventListener("click", doStress);
    btnChaos.addEventListener("click", doChaos);
    btnReset.addEventListener("click", resetSim);

    // ----- Containment actions -----
    btnCfa.addEventListener("click", () => {
      state.containment.alpha = !state.containment.alpha;
      log(`Containment Alpha (thermal buffer) ${state.containment.alpha ? "enabled" : "disabled"} (sim).`);
      updateContainHumGain();
      renderAll();
    });

    btnCfb.addEventListener("click", () => {
      state.containment.betaLatched = false;
      log("Containment Beta latch reset (sim).");
      updateContainHumGain();
      renderAll();
    });

    btnCfg.addEventListener("click", () => {
      state.containment.gamma = !state.containment.gamma;
      log(`Containment Gamma field ${state.containment.gamma ? "engaged" : "disengaged"} (sim).`);
      updateContainHumGain();
      renderAll();
    });

    btnPulse.addEventListener("click", () => {
      log("Containment pulse sweep triggered (sim).");
      state.rad = Math.max(0.05, state.rad - 0.6);
      renderAll();
    });

    btnLockdown.addEventListener("click", () => {
      toggleLockdown();
    });

    function toggleLockdown(forceOn) {
      const target = (typeof forceOn === "boolean") ? forceOn : !state.lockdown;
      state.lockdown = target;
      if (state.lockdown) {
        log("LOCKDOWN: High-risk controls restricted (sim).");
        btnLockdown.classList.add("lockdown-active");
      } else {
        log("LOCKDOWN: Restrictions lifted (sim).");
        btnLockdown.classList.remove("lockdown-active");
      }
      renderAll();
    }

    // ----- COMMS / BLACK CHAMBER actions -----
    btnSatlink.addEventListener("click", () => {
      state.satLink = !state.satLink;
      log(`SATLINK ${state.satLink ? "routed to sim uplink" : "disconnected"} (visual only).`);
      renderAll();
    });

    btnGhost.addEventListener("click", () => {
      state.ghostLink = !state.ghostLink;
      log(`GHOST MIRROR ${state.ghostLink ? "latched (sim)" : "released (sim)"}.`);
      renderAll();
    });

    btnBlack.addEventListener("click", () => {
      toggleBlackChamber();
    });

    function toggleBlackChamber(forceOn) {
      const target = (typeof forceOn === "boolean") ? forceOn : !state.blackChamber;
      state.blackChamber = target;
      if (state.blackChamber) {
        log("BLACK CHAMBER engaged (visual dark-mode layer only).");
      } else {
        log("BLACK CHAMBER disengaged.");
      }
      updateContainHumGain();
      renderAll();
    }

    btnMacroRec.addEventListener("click", () => {
      startMacroRecording();
    });

    btnMacroPlay.addEventListener("click", () => {
      playMacro();
    });

    function startMacroRecording() {
      state.macroRecording = true;
      state.macroBuffer = [];
      log("Macro recording started (sim). Commands will be captured until `macro stop`.");
    }

    function stopMacroRecording() {
      state.macroRecording = false;
      log("Macro recording stopped (sim). Use `macro play` to replay.");
    }

    function playMacro() {
      if (state.macroBuffer.length === 0) {
        log("Macro play: buffer empty.");
        return;
      }
      log(`Macro play: replaying ${state.macroBuffer.length} commands (sim).`);
      // simple immediate replay
      for (const cmd of state.macroBuffer) {
        runCommand(cmd);
      }
    }

    // ----- Diagnostics toggle -----
    btnDiag.addEventListener("click", () => {
      state.diagnostics = !state.diagnostics;
      elDiagCard.style.display = state.diagnostics ? "block" : "none";
      if (state.diagnostics) {
        elDiagCard.classList.add("diag-active");
        log("Diagnostics mode enabled (sim).");
      } else {
        elDiagCard.classList.remove("diag-active");
        log("Diagnostics mode disabled (sim).");
      }
      renderBadges();
    });

    // ----- Overdrive toggle -----
    btnOver.addEventListener("click", () => {
      if (state.meltdownStage > 0) {
        log("Overdrive: locked (meltdown sim active).");
        return;
      }
      if (state.lockdown) {
        log("Overdrive blocked by LOCKDOWN (sim).");
        return;
      }
      state.overdrive = !state.overdrive;
      if (state.overdrive) {
        log("Overdrive mode enabled (physics exaggerated, visual only).");
      } else {
        log("Overdrive mode disabled.");
      }
      renderBadges();
      renderTelemetry();
    });

    // ----- Theme handling -----
    function applyTheme(themeName) {
      state.theme = themeName;
      document.body.className = `theme-${themeName}`;
      themeButtons.forEach(btn => {
        const t = btn.getAttribute("data-theme");
        if (t === themeName) btn.classList.add("active");
        else btn.classList.remove("active");
      });

      if (themeName === "green") {
        elTitle.textContent = "Reactor + Containment + Black Chamber Console";
      } else if (themeName === "amber") {
        elTitle.textContent = "Black Chamber Console · Amber Core";
      } else if (themeName === "redline") {
        elTitle.textContent = "Black Chamber Console · Redline Sim";
      } else if (themeName === "2049") {
        elTitle.textContent = "Black Chamber Console · 2049 Mode (sim)";
      }
      log("Theme set: " + themeName);
      renderAll();
    }

    themeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const t = btn.getAttribute("data-theme");
        applyTheme(t);
      });
    });

    // hidden 2049 mode
    function unlock2049() {
      if (document.querySelector('[data-theme="2049"]')) return;
      const parent = themeButtons[0].parentElement;
      const btn = document.createElement("button");
      btn.className = "theme-btn";
      btn.setAttribute("data-theme", "2049");
      btn.innerHTML = '<span class="theme-dot" style="background:#38bdf8;"></span>2049';
      parent.appendChild(btn);
      themeButtons.push(btn);
      btn.addEventListener("click", () => applyTheme("2049"));
      log("Hidden theme unlocked: 2049 (sim aesthetics only).");
    }

    // ----- Terminal v1.6 -----
    const termHistory = [];
    let termIndex = -1;
    const commands = [
      "help","status","scram","relief","stress","chaos","reset",
      "diag on","diag off","overdrive on","overdrive off",
      "audio on","audio off","save-log","theme green","theme amber",
      "theme redline","theme 2049","power","coolant","engine status",
      "unlock 2049","containment status","lockdown on","lockdown off",
      "operator set","operator level","satlink on","satlink off",
      "ghost on","ghost off","black on","black off",
      "macro rec","macro stop","macro play"
    ];

    function runCommand(raw) {
      const cmd = String(raw || "").trim();
      if (!cmd) return;
      log("> " + cmd);

      // macro capture (record raw command, not log text)
      if (state.macroRecording && !cmd.toLowerCase().startsWith("macro ")) {
        state.macroBuffer.push(cmd);
      }

      termHistory.unshift(cmd);
      termIndex = -1;

      const lower = cmd.toLowerCase();

      if (lower === "help") {
        log("commands: help, status, scram, relief, stress, chaos, reset, power <n>, coolant <n>, overdrive on/off, diag on/off, audio on/off, theme <green|amber|redline|2049>, containment status, lockdown on/off, satlink on/off, ghost on/off, black on/off, macro rec/stop/play, operator set <name>, operator level <0-3>, engine status, save-log, unlock 2049");
        return;
      }

      if (lower === "status") {
        log("status: temp=" + Math.round(state.temp) + "C, p=" + state.pressure.toFixed(2) +
            "MPa, rad=" + state.rad.toFixed(2) + "mSv/h, sg=" + state.safeguards +
            ", od=" + (state.overdrive ? "on" : "off") + ", diag=" + (state.diagnostics ? "on" : "off") +
            ", meltdownStage=" + state.meltdownStage + ", satLink=" + state.satLink +
            ", black=" + state.blackChamber);
        return;
      }

      if (lower === "containment status") {
        log(`containment: alpha=${state.containment.alpha}, betaLatched=${state.containment.betaLatched}, gamma=${state.containment.gamma}, lockdown=${state.lockdown}`);
        return;
      }

      if (lower === "scram") { doScram(); return; }
      if (lower === "relief") { doRelief(); return; }
      if (lower === "stress") { doStress(); return; }
      if (lower === "chaos") { doChaos(); return; }
      if (lower === "reset") { resetSim(); return; }

      if (lower.startsWith("power ")) {
        const n = parseInt(lower.split(/\s+/)[1], 10);
        if (!isNaN(n)) {
          let v = Math.min(125, Math.max(40, n));
          leverCore.value = v;
          log("Core drive set via terminal: " + v);
        } else {
          log("Invalid power value.");
        }
        return;
      }

      if (lower.startsWith("coolant ")) {
        const n = parseInt(lower.split(/\s+/)[1], 10);
        if (!isNaN(n)) {
          let v = Math.min(145, Math.max(80, n));
          leverCool.value = v;
          log("Coolant bias set via terminal: " + v);
        } else {
          log("Invalid coolant value.");
        }
        return;
      }

      if (lower === "diag on") {
        if (!state.diagnostics) btnDiag.click();
        return;
      }
      if (lower === "diag off") {
        if (state.diagnostics) btnDiag.click();
        return;
      }

      if (lower === "overdrive on") {
        if (!state.overdrive) btnOver.click();
        return;
      }
      if (lower === "overdrive off") {
        if (state.overdrive) btnOver.click();
        return;
      }

      if (lower === "audio on") {
        if (!state.audioOn) { state.audioOn = true; applyAudioState(); }
        return;
      }
      if (lower === "audio off") {
        if (state.audioOn) { state.audioOn = false; applyAudioState(); }
        return;
      }

      if (lower.startsWith("theme ")) {
        const t = lower.split(/\s+/)[1];
        if (["green","amber","redline","2049"].includes(t)) {
          if (t === "2049") unlock2049();
          applyTheme(t);
        } else {
          log("Unknown theme. Use: green, amber, redline, 2049");
        }
        return;
      }

      if (lower === "engine status") {
        log("engine: ticks=" + state.ticks + ", meltdownStage=" + state.meltdownStage + ", overdrive=" + (state.overdrive?"on":"off") + ", lockdown=" + state.lockdown + ", blackChamber=" + state.blackChamber);
        return;
      }

      if (lower === "save-log") {
        maybePersist("[manual flush]\\n");
        log("log flush requested (sim)");
        return;
      }

      if (lower === "unlock 2049") {
        unlock2049();
        return;
      }

      if (lower === "lockdown on") {
        if (!state.lockdown) toggleLockdown(true);
        return;
      }

      if (lower === "lockdown off") {
        if (state.lockdown) toggleLockdown(false);
        return;
      }

      if (lower === "satlink on") {
        if (!state.satLink) {
          state.satLink = true;
          log("SATLINK routed to sim uplink (visual only).");
          renderAll();
        }
        return;
      }

      if (lower === "satlink off") {
        if (state.satLink) {
          state.satLink = false;
          log("SATLINK disconnected (sim).");
          renderAll();
        }
        return;
      }

      if (lower === "ghost on") {
        if (!state.ghostLink) {
          state.ghostLink = true;
          log("GHOST MIRROR latched (sim).");
          renderAll();
        }
        return;
      }

      if (lower === "ghost off") {
        if (state.ghostLink) {
          state.ghostLink = false;
          log("GHOST MIRROR released (sim).");
          renderAll();
        }
        return;
      }

      if (lower === "black on") {
        if (!state.blackChamber) toggleBlackChamber(true);
        return;
      }

      if (lower === "black off") {
        if (state.blackChamber) toggleBlackChamber(false);
        return;
      }

      if (lower === "macro rec") {
        startMacroRecording();
        return;
      }

      if (lower === "macro stop") {
        if (state.macroRecording) stopMacroRecording();
        else log("Macro stop: no recording active.");
        return;
      }

      if (lower === "macro play") {
        playMacro();
        return;
      }

      if (lower.startsWith("operator set ")) {
        const name = cmd.slice("operator set ".length).trim();
        if (!name) {
          log("operator set: missing name.");
          return;
        }
        state.operatorName = name;
        updateOperatorLines();
        log("Operator name set to: " + name);
        return;
      }

      if (lower.startsWith("operator level ")) {
        const n = parseInt(lower.split(/\s+/)[2], 10);
        if (isNaN(n)) {
          log("operator level: expected number 0–3.");
          return;
        }
        state.operatorLevel = Math.min(3, Math.max(0, n));
        updateOperatorLines();
        log("Operator level set to: " + state.operatorLevel + " (" + levelLabel(state.operatorLevel) + ")");
        return;
      }

      log("Unknown command — try `help`.");
    }

    termRun.addEventListener("click", () => {
      runCommand(termInput.value);
      termInput.value = "";
    });

    termInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        runCommand(termInput.value);
        termInput.value = "";
      } else if (e.key === "ArrowUp") {
        if (termHistory.length === 0) return;
        e.preventDefault();
        if (termIndex < termHistory.length - 1) termIndex++;
        termInput.value = termHistory[termIndex];
      } else if (e.key === "ArrowDown") {
        if (termHistory.length === 0) return;
        e.preventDefault();
        if (termIndex > 0) {
          termIndex--;
          termInput.value = termHistory[termIndex];
        } else {
          termIndex = -1;
          termInput.value = "";
        }
      } else if (e.key === "Tab") {
        e.preventDefault();
        const current = termInput.value.trim().toLowerCase();
        if (!current) return;
        const match = commands.find(c => c.startsWith(current));
        if (match) termInput.value = match;
      }
    });

    // ----- Init -----
    applyTheme("green");
    renderAll();
  </script>
</body>
</html>
